version: "3.9"
services:
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: synaptica
      POSTGRES_USER: synaptica
      POSTGRES_PASSWORD: synaptica123
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - synaptica

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    networks:
      - synaptica

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.3
    restart: unless-stopped
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - synaptica

  kafka:
    image: confluentinc/cp-kafka:7.5.3
    restart: unless-stopped
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
    networks:
      - synaptica

  api-gateway:
    build:
      context: ../..
      dockerfile: infra/docker/go.Dockerfile
      args:
        SERVICE_PATH: api-gateway
    depends_on:
      - postgres
      - redis
      - kafka
      - training-service
      - ingestion-service
      - dlp-service
      - deid-service
      - normalizer-service
      - linkage-service
      - storage-service
      - serving-service
      - cohort-service
      - edc-service
    environment:
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: "8080"
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: synaptica
      POSTGRES_PASSWORD: synaptica123
      POSTGRES_DB: synaptica
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      KAFKA_BROKERS: kafka:9092
      INGESTION_BASE_URL: http://ingestion-service:8081
      TRAINING_BASE_URL: http://training-service:8088
    networks:
      - synaptica

  ingestion-service:
    build:
      context: ../..
      dockerfile: infra/docker/go.Dockerfile
      args:
        SERVICE_PATH: ingestion-service
    depends_on:
      - postgres
      - kafka
    environment:
      SERVER_HOST: 0.0.0.0
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: synaptica
      POSTGRES_PASSWORD: synaptica123
      POSTGRES_DB: synaptica
      KAFKA_BROKERS: kafka:9092
      INGESTION_KAFKA_TOPIC: upstream-events
      INGESTION_DLQ_TOPIC: upstream-events-dlq
    networks:
      - synaptica

  dlp-service:
    build:
      context: ../..
      dockerfile: infra/docker/go.Dockerfile
      args:
        SERVICE_PATH: dlp-service
    depends_on:
      - kafka
    environment:
      SERVER_HOST: 0.0.0.0
      KAFKA_BROKERS: kafka:9092
      LINKAGE_KAFKA_TOPIC: linked-events
      DLP_RULES_PATH: /app/configs/dlp_rules.yaml
    volumes:
      - ../../configs/dlp_rules.yaml:/app/configs/dlp_rules.yaml:ro
    networks:
      - synaptica

  deid-service:
    build:
      context: ../..
      dockerfile: infra/docker/go.Dockerfile
      args:
        SERVICE_PATH: deid-service
    depends_on:
      - postgres
      - kafka
    environment:
      SERVER_HOST: 0.0.0.0
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: synaptica
      POSTGRES_PASSWORD: synaptica123
      POSTGRES_DB: synaptica
      KAFKA_BROKERS: kafka:9092
    networks:
      - synaptica

  normalizer-service:
    build:
      context: ../..
      dockerfile: infra/docker/go.Dockerfile
      args:
        SERVICE_PATH: normalizer-service
    depends_on:
      - postgres
      - kafka
    environment:
      SERVER_HOST: 0.0.0.0
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: synaptica
      POSTGRES_PASSWORD: synaptica123
      POSTGRES_DB: synaptica
      KAFKA_BROKERS: kafka:9092
      TERMINOLOGY_CATALOG_PATH: /app/configs/terminology.yaml
    volumes:
      - ../../configs/terminology.yaml:/app/configs/terminology.yaml:ro
    networks:
      - synaptica

  linkage-service:
    build:
      context: ../..
      dockerfile: infra/docker/go.Dockerfile
      args:
        SERVICE_PATH: linkage-service
    depends_on:
      - postgres
      - kafka
    environment:
      SERVER_HOST: 0.0.0.0
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: synaptica
      POSTGRES_PASSWORD: synaptica123
      POSTGRES_DB: synaptica
      KAFKA_BROKERS: kafka:9092
    networks:
      - synaptica

  storage-service:
    build:
      context: ../..
      dockerfile: infra/docker/go.Dockerfile
      args:
        SERVICE_PATH: storage-service
    depends_on:
      - postgres
      - kafka
      - redis
    environment:
      SERVER_HOST: 0.0.0.0
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: synaptica
      POSTGRES_PASSWORD: synaptica123
      POSTGRES_DB: synaptica
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      KAFKA_BROKERS: kafka:9092
    networks:
      - synaptica

  training-service:
    build:
      context: ../..
      dockerfile: infra/docker/go.Dockerfile
      args:
        SERVICE_PATH: training-service
    depends_on:
      - postgres
      - redis
    environment:
      SERVER_HOST: 0.0.0.0
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: synaptica
      POSTGRES_PASSWORD: synaptica123
      POSTGRES_DB: synaptica
      REDIS_HOST: redis
      REDIS_PORT: "6379"
      TRAINING_ARTIFACT_DIR: /data/artifacts
    volumes:
      - training_artifacts:/data/artifacts
    networks:
      - synaptica

  serving-service:
    build:
      context: ../..
      dockerfile: infra/docker/go.Dockerfile
      args:
        SERVICE_PATH: serving-service
    depends_on:
      - postgres
      - redis
    environment:
      SERVER_HOST: 0.0.0.0
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: synaptica
      POSTGRES_PASSWORD: synaptica123
      POSTGRES_DB: synaptica
      REDIS_HOST: redis
      REDIS_PORT: "6379"
    networks:
      - synaptica

  cohort-service:
    build:
      context: ../..
      dockerfile: infra/docker/go.Dockerfile
      args:
        SERVICE_PATH: cohort-service
    depends_on:
      - postgres
    environment:
      SERVER_HOST: 0.0.0.0
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: synaptica
      POSTGRES_PASSWORD: synaptica123
      POSTGRES_DB: synaptica
    networks:
      - synaptica

  edc-service:
    build:
      context: ../..
      dockerfile: infra/docker/go.Dockerfile
      args:
        SERVICE_PATH: edc-service
    depends_on:
      - postgres
    environment:
      SERVER_HOST: 0.0.0.0
      EDC_SERVICE_PORT: "8091"
      POSTGRES_HOST: postgres
      POSTGRES_PORT: "5432"
      POSTGRES_USER: synaptica
      POSTGRES_PASSWORD: synaptica123
      POSTGRES_DB: synaptica
    networks:
      - synaptica

  frontend:
    build:
      context: ../../frontend
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_API_BASE: /api
    depends_on:
      - api-gateway
    networks:
      - synaptica

  nginx:
    image: nginx:1.25-alpine
    depends_on:
      - frontend
      - api-gateway
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8080:80"
    networks:
      - synaptica

networks:
  synaptica:
    driver: bridge

volumes:
  postgres_data:
  training_artifacts:
